<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Elsa AI Image Generator</title>
    <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          height: 100vh;
          display: flex;
          justify-content: center;
          align-items: center;
          padding: 20px;
      }

      .chat-container {
          background: white;
          border-radius: 20px;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
          width: 100%;
          max-width: 900px;
          height: 90vh;
          display: flex;
          flex-direction: column;
          overflow: hidden;
      }

      .chat-header {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 20px;
          text-align: center;
      }

      .chat-header h1 {
          font-size: 24px;
          font-weight: 600;
      }

      .chat-header p {
          font-size: 14px;
          opacity: 0.9;
          margin-top: 5px;
      }

      .chat-messages {
          flex: 1;
          overflow-y: auto;
          padding: 20px;
          background: #f8f9fa;
      }

      .message {
          margin-bottom: 20px;
          display: flex;
          flex-direction: column;
      }

      .message.user {
          align-items: flex-end;
      }

      .message.assistant {
          align-items: flex-start;
      }

      .message-bubble {
          max-width: 70%;
          padding: 12px 16px;
          border-radius: 18px;
          word-wrap: break-word;
      }

      .message.user .message-bubble {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          border-bottom-right-radius: 4px;
      }

      .message.assistant .message-bubble {
          background: white;
          color: #333;
          border-bottom-left-radius: 4px;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .message.assistant .message-bubble.error {
          background: #fee;
          color: #c33;
          border-left: 3px solid #c33;
      }

      /* NEW: Style for the enhanced prompt */
      .enhanced-prompt {
          font-size: 0.9em;
          font-style: italic;
          color: #555;
          background: #f0f0f0;
          padding: 8px 12px;
          border-radius: 8px;
          margin-bottom: 10px;
          border-left: 3px solid #667eea;
      }

      .image-container {
          margin-top: 10px;
          border-radius: 12px;
          overflow: hidden;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
          max-width: 100%;
      }

      .image-container img {
          width: 100%;
          height: auto;
          display: block;
      }

      .download-btn {
          margin-top: 10px;
          padding: 8px 16px;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          font-size: 14px;
          font-weight: 500;
          transition: transform 0.2s, box-shadow 0.2s;
      }

      .download-btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }

      .download-btn:active {
          transform: translateY(0);
      }

      .chat-input-container {
          padding: 20px;
          background: white;
          border-top: 1px solid #e0e0e0;
      }

      .chat-input-wrapper {
          display: flex;
          gap: 10px;
      }

      .chat-input {
          flex: 1;
          padding: 12px 16px;
          border: 2px solid #e0e0e0;
          border-radius: 25px;
          font-size: 14px;
          outline: none;
          transition: border-color 0.3s;
          resize: vertical;
          min-height: 44px;
          max-height: 150px;
          font-family: inherit;
      }

      .chat-input:focus {
          border-color: #667eea;
      }

      textarea.chat-input {
          border-radius: 12px;
          padding: 12px 16px;
          line-height: 1.5;
      }

      .send-btn {
          padding: 12px 24px;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          border: none;
          border-radius: 25px;
          cursor: pointer;
          font-size: 14px;
          font-weight: 600;
          transition: transform 0.2s, box-shadow 0.2s;
      }

      /* New Enhance Button Style */
      .enhance-btn {
          padding: 12px 20px;
          background: #f0f0f0;
          color: #333;
          border: 2px solid #667eea;
          border-radius: 25px;
          cursor: pointer;
          font-size: 14px;
          font-weight: 600;
          transition: all 0.2s;
      }

      .enhance-btn:hover:not(:disabled) {
          background: #e0e0e0;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .send-btn:hover:not(:disabled) {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }

      .send-btn:disabled, .enhance-btn:disabled {
          opacity: 0.6;
          cursor: not-allowed;
      }

      .loading {
          display: inline-block;
          width: 20px;
          height: 20px;
          border: 3px solid rgba(102, 126, 234, 0.3);
          border-radius: 50%;
          border-top-color: #667eea;
          animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
          to { transform: rotate(360deg); }
      }

      .text-content {
          white-space: pre-wrap;
          line-height: 1.6;
      }

      /* Text content inside a bubble */
      .message-bubble .text-content {
          white-space: pre-wrap;
      }

      /* Scrollbar styling */
      .chat-messages::-webkit-scrollbar {
          width: 8px;
      }

      .chat-messages::-webkit-scrollbar-track {
          background: #f1f1f1;
      }

      .chat-messages::-webkit-scrollbar-thumb {
          background: #888;
          border-radius: 4px;
      }

      .chat-messages::-webkit-scrollbar-thumb:hover {
          background: #555;
      }
    </style>
  </head>
  <body>
    <div class="chat-container">
      <div class="chat-header">
        <h1>âœ¨ Elsa AI Image Generator</h1>
        <p>Generate Chibi, Robot, or General images with AI</p>
      </div>

      <div class="chat-messages" id="chatMessages">
        <div class="message assistant">
          <div class="message-bubble">
            <div class="text-content">
              Hello! I'm Elsa AI. I can generate images, diagrams, or create
              X/Twitter banners from articles. â€¢ **Send:** Generate exactly what
              you type â€¢ **âœ¨ Enhance & Generate:** Perfect for creating
              banners! Paste your article text and I'll create a professional
              X/Twitter banner optimized for social media What would you like me
              to create?
            </div>
          </div>
        </div>
      </div>

      <div class="chat-input-container">
        <div class="chat-input-wrapper">
          <textarea
            class="chat-input"
            id="chatInput"
            placeholder="Paste article text for banner, or type a prompt..."
            autocomplete="off"
            rows="1"
          ></textarea>
          <!-- New Enhance Button -->
          <button
            class="enhance-btn"
            id="enhanceBtn"
            onclick="sendEnhancedMessage()"
          >
            âœ¨ Enhance & Generate
          </button>
          <button class="send-btn" id="sendBtn" onclick="sendMessage()">
            Send
          </button>
        </div>
      </div>
    </div>

    <script>
      const chatMessages = document.getElementById('chatMessages');
      const chatInput = document.getElementById('chatInput');
      const sendBtn = document.getElementById('sendBtn');
      const enhanceBtn = document.getElementById('enhanceBtn'); // New button

      // Auto-resize textarea
      chatInput.addEventListener('input', function() {
          this.style.height = 'auto';
          this.style.height = Math.min(this.scrollHeight, 150) + 'px';
      });

      // Allow Enter key to send message (Shift+Enter for new line)
      chatInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              sendMessage(); // Default action is the simple 'Send'
          }
      });

      // Add a single function to handle both button clicks
      async function sendMessage(useEnhancer = false) {
          const prompt = chatInput.value.trim();
          if (!prompt) return;

          // Add user message
          addMessage(prompt, true, 'text');
          chatInput.value = '';
          setLoading(true);

          // Add loading indicator
          addLoadingMessage();

          // Determine which API endpoint to call
          const endpoint = useEnhancer ? '/api/enhance_and_generate' : '/api/chat';

          try {
              const response = await fetch(endpoint, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({ prompt: prompt })
              });

              const data = await response.json();
              removeLoadingMessage();

              if (data.success) {
                  // NEW: Check if the enhanced prompt is returned and display it
                  const enhancedPrompt = data.enhanced_prompt ? data.enhanced_prompt : null;

                  if (data.type === 'image') {
                      addMessage(data.message, false, 'image', data.data, enhancedPrompt);
                  } else {
                      addMessage(data.data || data.message, false, 'text', null, enhancedPrompt);
                  }
              } else {
                  addMessage(data.message || 'An error occurred', false, 'error');
              }
          } catch (error) {
              removeLoadingMessage();
              addMessage(`Error: ${error.message}`, false, 'error');
          } finally {
              setLoading(false);
              chatInput.focus();
          }
      }

      // NEW: Wrapper function for the enhance button
      function sendEnhancedMessage() {
          sendMessage(true);
      }


      function addMessage(content, isUser, type = 'text', imageData = null, enhancedPrompt = null) {
          const messageDiv = document.createElement('div');
          messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;

          const bubble = document.createElement('div');
          bubble.className = 'message-bubble';

          if (type === 'error') {
              bubble.classList.add('error');
          }

          // NEW: If an enhanced prompt exists, add it to the bubble
          if (enhancedPrompt) {
              const enhancedDiv = document.createElement('div');
              enhancedDiv.className = 'enhanced-prompt';
              enhancedDiv.innerHTML = `<strong>Enhanced Prompt:</strong><br>${escapeHTML(enhancedPrompt)}`;
              bubble.appendChild(enhancedDiv);
          }

          if (type === 'image' && imageData) {
              const textContent = document.createElement('div');
              textContent.className = 'text-content';
              textContent.textContent = content; // e.g., "Chibi image generated successfully!"
              bubble.appendChild(textContent);

              const imageContainer = document.createElement('div');
              imageContainer.className = 'image-container';

              const img = document.createElement('img');
              img.src = `data:image/png;base64,${imageData}`;
              img.alt = 'Generated image';
              imageContainer.appendChild(img);

              const downloadBtn = document.createElement('button');
              downloadBtn.className = 'download-btn';
              downloadBtn.textContent = 'ðŸ“¥ Download Image';
              downloadBtn.onclick = () => downloadImage(imageData);
              imageContainer.appendChild(downloadBtn);

              bubble.appendChild(imageContainer);
          } else {
              const textContent = document.createElement('div');
              textContent.className = 'text-content';
              textContent.textContent = content;
              bubble.appendChild(textContent);
          }

          messageDiv.appendChild(bubble);
          chatMessages.appendChild(messageDiv);
          chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function addLoadingMessage() {
          const messageDiv = document.createElement('div');
          messageDiv.className = 'message assistant';
          messageDiv.id = 'loadingMessage';

          const bubble = document.createElement('div');
          bubble.className = 'message-bubble';
          bubble.innerHTML = '<div class="loading"></div>';

          messageDiv.appendChild(bubble);
          chatMessages.appendChild(messageDiv);
          chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function removeLoadingMessage() {
          const loadingMsg = document.getElementById('loadingMessage');
          if (loadingMsg) {
              loadingMsg.remove();
          }
      }

      function downloadImage(base64Data) {
          const link = document.createElement('a');
          link.href = `data:image/png;base64,${base64Data}`;
          link.download = `elsa-generated-${Date.now()}.png`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
      }

      function setLoading(isLoading) {
          sendBtn.disabled = isLoading;
          enhanceBtn.disabled = isLoading; // Disable both buttons
          sendBtn.innerHTML = isLoading ? '<div class="loading"></div>' : 'Send';
          enhanceBtn.innerHTML = isLoading ? '<div class="loading"></div>' : 'âœ¨ Enhance & Generate';
      }

      function escapeHTML(str) {
          return str.replace(/[&<>"']/g, function(m) {
              return {
                  '&': '&amp;',
                  '<': '&lt;',
                  '>': '&gt;',
                  '"': '&quot;',
                  "'": '&#39;'
              }[m];
          });
      }
    </script>
  </body>
</html>
